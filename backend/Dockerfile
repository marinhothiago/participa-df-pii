# ===========================================
# Participa DF - Backend Dockerfile
# Vers√£o 9.2 - Ensemble 5 Fontes NER + Confian√ßa Probabil√≠stica
# ===========================================

# 1. Base Python 3.10 (compat√≠vel com spaCy 3.8 e torch 2.1)
FROM python:3.10-slim

# 2. Vari√°veis de ambiente para otimiza√ß√£o
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# 3. Instala depend√™ncias do sistema (m√≠nimas)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

WORKDIR /app

# 4. Copia apenas requirements primeiro (cache de camadas Docker)
COPY requirements.txt .

# 5. Instala√ß√£o de depend√™ncias em ordem otimizada
# 5.1 PyTorch CPU (antes do resto para cache)
RUN pip install --no-cache-dir \
    torch==2.1.0+cpu \
    --index-url https://download.pytorch.org/whl/cpu

# 5.2 Depend√™ncias do requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

# 5.3 Modelo spaCy para portugu√™s (grande)
RUN pip install --no-cache-dir \
    https://github.com/explosion/spacy-models/releases/download/pt_core_news_lg-3.8.0/pt_core_news_lg-3.8.0-py3-none-any.whl

# 6. Pr√©-download dos modelos NER
# 6.1 BERT Davlan multil√≠ngue (PER, ORG, LOC, DATE)
RUN python -c "\
from transformers import pipeline; \
print('üì• Baixando modelo BERT Davlan NER multil√≠ngue...'); \
pipeline('ner', model='Davlan/bert-base-multilingual-cased-ner-hrl', aggregation_strategy='simple'); \
print('‚úÖ BERT Davlan pronto!')"

# 6.2 NuNER pt-BR especializado em portugu√™s brasileiro
RUN python -c "\
from transformers import pipeline; \
print('üì• Baixando modelo NuNER pt-BR...'); \
pipeline('ner', model='monilouise/ner_news_portuguese', aggregation_strategy='simple'); \
print('‚úÖ NuNER pt-BR pronto!')"

# 7. Copia c√≥digo da aplica√ß√£o
COPY . .

# 8. Cria diret√≥rios de dados com permiss√µes
RUN mkdir -p /app/data/input /app/data/output && chmod -R 777 /app/data

# 9. Porta da aplica√ß√£o (HuggingFace Spaces usa 7860)
EXPOSE 7860

# 10. Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:7860/health || exit 1

# 11. Comando de inicializa√ß√£o
CMD ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "7860"]
